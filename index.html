<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Make the page mobile-friendly -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Link to your manifest -->
  <link rel="manifest" href="manifest.json">
  <title>Personal Web App Host</title>
  <style>
    /* Base styling */
    textarea {
      width: 100%;
      height: 200px;
    }
    iframe {
      width: 100%;
      border: 1px solid #ccc;
    }
    button {
      margin: 5px;
    }
    #previewFrame {
      height: 300px;
    }
    .banner {
      float: right;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .banner {
        display: none;
        margin: 0 auto;
        text-align: center;
      }

      /* Make sure there's a bit of breathing room */
      #editorUI, #appView {
        padding: 10px;
      }

      /* Stack buttons vertically for easier taps */
      button {
        display: block;
        width: 100%;
        margin: 10px 0;
      }

      /* Adjust textarea height on smaller screens */
      textarea {
        height: 150px;
      }

      /* Adjust preview height on smaller screens */
      #previewFrame {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <!-- Fork me on GitHub banner - only shown in editor mode -->
  <div id="githubBanner">
    <a href="https://github.com/danieljonce/pwa">
      <img decoding="async" width="149" height="149"
           src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png"
           class="banner attachment-full size-full" alt="Fork me on GitHub" loading="lazy">
    </a>
  </div>
  
  <!-- Editor UI -->
  <div id="editorUI" style="display: none;">
    <h1>Personal Web App Host</h1>
    <h2>Quickly create a personal web app.</h2>
    <p><a href="https://github.com/danieljonce/pwa">Learn more.</a></p>
    <h2>HTML</h2>
    <textarea id="htmlInput" placeholder="Enter your HTML code here"></textarea>
    <br>
    <button id="saveBtn">Save &amp; Preview</button>
    <button id="exportBtn">Export App</button>
    <button id="viewAppBtn">View App</button>
    <h2>Preview</h2>
    <iframe id="previewFrame"></iframe>
  </div>

  <!-- App View (shown when a custom app has been saved) -->
  <div id="appView" style="display: none; width:100%; height:100vh;">
    <iframe id="appFrame" style="width:100%; height:100%; border:none;"></iframe>
  </div>

  <!-- Loading indicator -->
  <div id="loadingUI" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
    <h2>Loading...</h2>
    <p>Please wait while we set up your app.</p>
  </div>

  <script>
    // --- IndexedDB Helpers ---
    function openDatabase() {
      return new Promise(function(resolve, reject) {
        const request = indexedDB.open('pwaGenerator', 1);
        request.onupgradeneeded = function(event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('app')) {
            db.createObjectStore('app', { keyPath: 'id' });
          }
        };
        request.onsuccess = function(event) {
          resolve(event.target.result);
        };
        request.onerror = function(event) {
          reject(event.target.error);
        };
      });
    }

    function getCustomHTML() {
      // Use hostname as the unique key for the app
      const appKey = window.location.hostname;
      
      return openDatabase().then(function(db) {
        return new Promise(function(resolve, reject) {
          const transaction = db.transaction('app', 'readonly');
          const store = transaction.objectStore('app');
          const getRequest = store.get(appKey);
          getRequest.onsuccess = function() {
            resolve(getRequest.result ? getRequest.result.html : null);
          };
          getRequest.onerror = function() {
            resolve(null);
          };
        });
      });
    }

    function saveCustomHTML(html) {
      // Use hostname as the unique key for the app
      const appKey = window.location.hostname;
      
      return openDatabase().then(function(db) {
        return new Promise(function(resolve, reject) {
          const transaction = db.transaction('app', 'readwrite');
          const store = transaction.objectStore('app');
          const putRequest = store.put({ id: appKey, html: html });
          putRequest.onsuccess = function() {
            resolve();
          };
          putRequest.onerror = function() {
            reject(putRequest.error);
          };
        });
      });
    }

    // --- Request Persistent Storage ---
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist().then(function(granted) {
        console.log("Persistent storage granted:", granted);
      });
    }

    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
      // Show loading indicator initially
      document.getElementById('loadingUI').style.display = 'flex';
      document.getElementById('editorUI').style.display = 'none';
      document.getElementById('appView').style.display = 'none';
      
      // Check if we're in edit mode (if "edit" is in the URL)
      const isEditMode = window.location.pathname.includes('/edit');
      
      // Register the service worker first
      let serviceWorkerPromise = Promise.resolve();
      if ('serviceWorker' in navigator) {
        serviceWorkerPromise = navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(error) {
            console.error('Service Worker registration failed:', error);
          });
      }

      // Wait for both service worker registration and data retrieval
      Promise.all([serviceWorkerPromise, getCustomHTML()])
        .then(function(results) {
          const savedHTML = results[1];
          
          // Hide loading UI
          document.getElementById('loadingUI').style.display = 'none';
          
          if (savedHTML && !isEditMode) {
            // Display the custom app view - hide GitHub banner
            document.getElementById('editorUI').style.display = 'none';
            document.getElementById('appView').style.display = 'block';
            document.getElementById('githubBanner').style.display = 'none';
            document.title = "Your Custom App";
            document.getElementById('appFrame').srcdoc = savedHTML;
          } else {
            // Show the editor UI
            document.getElementById('editorUI').style.display = 'block';
            document.getElementById('githubBanner').style.display = 'block';
            
            // If there's saved HTML, populate the editor
            if (savedHTML) {
              document.getElementById('htmlInput').value = savedHTML;
            }
          }
        });

      const htmlInput = document.getElementById('htmlInput');
      const previewFrame = document.getElementById('previewFrame');
      const viewAppBtn = document.getElementById('viewAppBtn');

      // Save and preview the custom HTML
      document.getElementById('saveBtn').addEventListener('click', function() {
        const htmlCode = htmlInput.value;
        saveCustomHTML(htmlCode).then(function() {
          previewFrame.srcdoc = htmlCode;
        });
      });

      // Export the app as a downloadable "index.html"
      document.getElementById('exportBtn').addEventListener('click', function() {
        const htmlCode = htmlInput.value;
        const blob = new Blob([htmlCode], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'index.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // "View App": Save to IndexedDB then navigate to the root of the current hostname
      viewAppBtn.addEventListener('click', function() {
        const htmlCode = htmlInput.value;
        saveCustomHTML(htmlCode).then(function() {
          // Navigate to the root URL of the current hostname
          window.location.href = window.location.origin + '/';
        });
      });
    });
  </script>
</body>
</html>
